"""
=================================================================================
                ุฃูุซูุฉ ุงุณุชุฎุฏุงู ุฎุงุฏู MT5 ุงููุณูุท
                MT5 Middleware Server Usage Examples
=================================================================================

ูุฐุง ุงูููู ูุญุชูู ุนูู ุฃูุซูุฉ ุนูููุฉ ูุงุณุชุฎุฏุงู API ุงูุฎุงุฏู.
ููููู ุชุดุบูู ูุฐู ุงูุฃูุซูุฉ ุจุนุฏ ุชุดุบูู ุงูุฎุงุฏู ุนูู http://localhost:8000

"""

import requests
import json
from typing import Optional

# =================================================================================
#                              ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ
# =================================================================================

# ุนููุงู ุงูุฎุงุฏู
BASE_URL = "http://localhost:8000"

# โ๏ธ ุถุน ููุง ูุณุงุฑ MT5 ุงูุฎุงุต ุจู
# ูููุฐุฌ: "C:/Program Files/MetaTrader 5/terminal64.exe"
MT5_TERMINAL_PATH = "C:/Program Files/MetaTrader 5/terminal64.exe"

# โ๏ธ ุถุน ููุง ูุณุงุฑ ูุฌูุฏ MQL5 ุงูุฎุงุต ุจู
# ููุนุซูุฑ ุนููู: ุงูุชุญ MT5 > File > Open Data Folder
MQL5_PATH = "C:/Users/YOUR_USERNAME/AppData/Roaming/MetaQuotes/Terminal/XXXX/MQL5"

# ุจูุงูุงุช ุงูุญุณุงุจ (ุงุฎุชูุงุฑู)
MT5_LOGIN = None  # ูุซุงู: 12345678
MT5_PASSWORD = None  # ูุซุงู: "your_password"
MT5_SERVER = None  # ูุซุงู: "MetaQuotes-Demo"


# =================================================================================
#                              ุฏูุงู ูุณุงุนุฏุฉ
# =================================================================================

def print_response(title: str, response: requests.Response):
    """ุทุจุงุนุฉ ุงูุงุณุชุฌุงุจุฉ ุจุดูู ููุณู"""
    print(f"\n{'='*60}")
    print(f"๐ {title}")
    print(f"{'='*60}")
    print(f"ุงูุญุงูุฉ: {response.status_code}")
    try:
        data = response.json()
        print(json.dumps(data, ensure_ascii=False, indent=2))
    except:
        print(response.text)
    print()


# =================================================================================
#                              ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู
# =================================================================================

def example_health_check():
    """
    ูุซุงู 1: ูุญุต ุญุงูุฉ ุงูุฎุงุฏู
    
    ูุฐุง ุงููุซุงู ูุชุญูู ูู ุฃู ุงูุฎุงุฏู ูุนูู ุจุดูู ุตุญูุญ.
    """
    print("\n" + "๐ ูุซุงู 1: ูุญุต ุญุงูุฉ ุงูุฎุงุฏู".center(60, "="))
    
    response = requests.get(f"{BASE_URL}/health")
    print_response("ูุญุต ุงูุญุงูุฉ", response)
    
    return response.json()


def example_connect():
    """
    ูุซุงู 2: ุงูุงุชุตุงู ุจู MT5
    
    ูููู ุจุชููุฆุฉ ุงูุงุชุตุงู ูุน ููุตุฉ MetaTrader 5.
    """
    print("\n" + "๐ ูุซุงู 2: ุงูุงุชุตุงู ุจู MT5".center(60, "="))
    
    payload = {
        "terminal_path": MT5_TERMINAL_PATH
    }
    
    # ุฅุถุงูุฉ ุจูุงูุงุช ุงูุฏุฎูู ุฅุฐุง ูุงูุช ูุชููุฑุฉ
    if MT5_LOGIN:
        payload["login"] = MT5_LOGIN
    if MT5_PASSWORD:
        payload["password"] = MT5_PASSWORD
    if MT5_SERVER:
        payload["server"] = MT5_SERVER
    
    response = requests.post(f"{BASE_URL}/connect", json=payload)
    print_response("ูุชูุฌุฉ ุงูุงุชุตุงู", response)
    
    return response.json()


def example_disconnect():
    """
    ูุซุงู 3: ูุทุน ุงูุงุชุตุงู
    
    ูููู ุจุฅุบูุงู ุงูุงุชุตุงู ูุน MT5 ูุชุญุฑูุฑ ุงูููุงุฑุฏ.
    """
    print("\n" + "๐ ูุซุงู 3: ูุทุน ุงูุงุชุตุงู".center(60, "="))
    
    response = requests.post(f"{BASE_URL}/disconnect")
    print_response("ูุชูุฌุฉ ูุทุน ุงูุงุชุตุงู", response)
    
    return response.json()


def example_account_info():
    """
    ูุซุงู 4: ูุนูููุงุช ุงูุญุณุงุจ
    
    ูุฌูุจ ูุนูููุงุช ุงูุญุณุงุจ ุงููุชุตู (ุงูุฑุตูุฏุ ุงูุฃุฑุจุงุญุ ุงููุงูุดุ ุฅูุฎ).
    ููุงุญุธุฉ: ูุฌุจ ุงูุงุชุตุงู ุฃููุงู ุจุงุณุชุฎุฏุงู /connect
    """
    print("\n" + "๐ฐ ูุซุงู 4: ูุนูููุงุช ุงูุญุณุงุจ".center(60, "="))
    
    response = requests.get(f"{BASE_URL}/account_info")
    print_response("ูุนูููุงุช ุงูุญุณุงุจ", response)
    
    return response.json()


def example_list_experts():
    """
    ูุซุงู 5: ูุงุฆูุฉ ุงููุณุชุดุงุฑูู ุงูุฎุจุฑุงุก
    
    ูุณุชุนุฑุถ ุฌููุน EAs ุงููุชุงุญุฉ ูู ูุฌูุฏ MQL5/Experts.
    """
    print("\n" + "๐ค ูุซุงู 5: ูุงุฆูุฉ ุงููุณุชุดุงุฑูู ุงูุฎุจุฑุงุก".center(60, "="))
    
    payload = {
        "mql5_path": MQL5_PATH
    }
    
    response = requests.post(f"{BASE_URL}/list_experts", json=payload)
    print_response("ูุงุฆูุฉ ุงููุณุชุดุงุฑูู", response)
    
    return response.json()


def example_run_backtest():
    """
    ูุซุงู 6: ุชุดุบูู ุงุฎุชุจุงุฑ ุงุณุชุฑุงุชูุฌูุฉ (Backtest)
    
    ูุฐุง ูู ุงููุซุงู ุงูุฃูู - ูููู ุจุชุดุบูู ุงุฎุชุจุงุฑ ุฎููู ููุณุชุดุงุฑ ุฎุจูุฑ.
    
    โ๏ธ ุชุฃูุฏ ูู:
    1. ูุฌูุฏ ุงููุณุชุดุงุฑ ุงูุฎุจูุฑ ุงููุญุฏุฏ ูู MQL5/Experts
    2. ุฃู ุงูููู ูุชุฑุฌู (.ex5)
    3. ุตุญุฉ ุงุณู ุงูุฑูุฒ (Symbol)
    """
    print("\n" + "๐ ูุซุงู 6: ุชุดุบูู Backtest".center(60, "="))
    
    payload = {
        "terminal_path": MT5_TERMINAL_PATH,
        "expert_advisor": "ExpertMACD",      # โ๏ธ ุบููุฑ ูุฐุง ูุงุณู EA ุงูุฎุงุต ุจู
        "symbol": "EURUSD",                  # ุฑูุฒ ุงูุฒูุฌ
        "period": "H1",                      # ุงูุฅุทุงุฑ ุงูุฒููู
        "from_date": "2024.01.01",           # ุชุงุฑูุฎ ุงูุจุฏุงูุฉ
        "to_date": "2024.06.30",             # ุชุงุฑูุฎ ุงูููุงูุฉ
        "deposit": 10000,                    # ุฑุฃุณ ุงููุงู
        "leverage": 100,                     # ุงูุฑุงูุนุฉ ุงููุงููุฉ
        "model": 0,                          # 0=ูู ุชูู, 1=ููุงุท ุชุญูู, 2=ุฃุณุนุงุฑ ุงูุชุชุงุญ
        "optimization": 0,                   # 0=ูุนุทู, 1=ุจุทูุก, 2=ุฌููู
        "visual": 0                          # 0=ูุนุทู, 1=ููุนู
    }
    
    print("๐ ุฅุนุฏุงุฏุงุช ุงูุงุฎุชุจุงุฑ:")
    print(f"   โข ุงููุณุชุดุงุฑ: {payload['expert_advisor']}")
    print(f"   โข ุงูุฑูุฒ: {payload['symbol']}")
    print(f"   โข ุงูุฅุทุงุฑ: {payload['period']}")
    print(f"   โข ุงููุชุฑุฉ: {payload['from_date']} - {payload['to_date']}")
    print(f"   โข ุฑุฃุณ ุงููุงู: ${payload['deposit']}")
    
    response = requests.post(f"{BASE_URL}/run_backtest", json=payload)
    print_response("ูุชูุฌุฉ ุชุดุบูู ุงูุงุฎุชุจุงุฑ", response)
    
    return response.json()


def example_get_symbols():
    """
    ูุซุงู 7: ูุงุฆูุฉ ุงูุฑููุฒ ุงููุชุงุญุฉ
    
    ูุฌูุจ ูุงุฆูุฉ ุจุฌููุน ุฃุฒูุงุฌ ุงูุนููุงุช ูุงูุฑููุฒ ุงููุชุงุญุฉ ููุชุฏุงูู.
    ููุงุญุธุฉ: ูุฌุจ ุงูุงุชุตุงู ุฃููุงู ุจุงุณุชุฎุฏุงู /connect
    """
    print("\n" + "๐ ูุซุงู 7: ูุงุฆูุฉ ุงูุฑููุฒ".center(60, "="))
    
    response = requests.get(f"{BASE_URL}/symbols")
    print_response("ุงูุฑููุฒ ุงููุชุงุญุฉ", response)
    
    return response.json()


# =================================================================================
#                              ุณููุงุฑูู ูุงูู
# =================================================================================

def full_scenario():
    """
    ุณููุงุฑูู ูุงูู: ุงูุงุชุตุงู > ูุญุต ุงูุญุณุงุจ > ุชุดุบูู ุงุฎุชุจุงุฑ > ูุทุน ุงูุงุชุตุงู
    
    ูุฐุง ุงููุซุงู ููุถุญ ุณูุฑ ุงูุนูู ุงููุงูู ูุงุณุชุฎุฏุงู ุงูุฎุงุฏู.
    """
    print("\n" + "๐ฏ ุณููุงุฑูู ูุงูู".center(70, "="))
    print("""
    ูุฐุง ุงูุณููุงุฑูู ููุถุญ ุงูุงุณุชุฎุฏุงู ุงููุงูู ููุฎุงุฏู:
    1. ูุญุต ุญุงูุฉ ุงูุฎุงุฏู
    2. ุงูุงุชุตุงู ุจู MT5
    3. ุฌูุจ ูุนูููุงุช ุงูุญุณุงุจ
    4. ุงุณุชุนุฑุงุถ ุงููุณุชุดุงุฑูู ุงูุฎุจุฑุงุก
    5. ุชุดุบูู ุงุฎุชุจุงุฑ ุงุณุชุฑุงุชูุฌูุฉ
    6. ูุทุน ุงูุงุชุตุงู
    """)
    
    try:
        # 1. ูุญุต ุงูุญุงูุฉ
        print("\nโถ ุงูุฎุทูุฉ 1: ูุญุต ุญุงูุฉ ุงูุฎุงุฏู...")
        health = example_health_check()
        if health.get("status") != "healthy":
            print("โ ุงูุฎุงุฏู ุบูุฑ ูุชุงุญ!")
            return
        
        # 2. ุงูุงุชุตุงู
        print("\nโถ ุงูุฎุทูุฉ 2: ุงูุงุชุตุงู ุจู MT5...")
        connect_result = example_connect()
        if not connect_result.get("success"):
            print("โ ูุดู ุงูุงุชุตุงู!")
            return
        
        # 3. ูุนูููุงุช ุงูุญุณุงุจ
        print("\nโถ ุงูุฎุทูุฉ 3: ุฌูุจ ูุนูููุงุช ุงูุญุณุงุจ...")
        example_account_info()
        
        # 4. ูุงุฆูุฉ EAs
        print("\nโถ ุงูุฎุทูุฉ 4: ุงุณุชุนุฑุงุถ ุงููุณุชุดุงุฑูู ุงูุฎุจุฑุงุก...")
        example_list_experts()
        
        # 5. ุชุดุบูู Backtest
        print("\nโถ ุงูุฎุทูุฉ 5: ูู ุชุฑูุฏ ุชุดุบูู ุงุฎุชุจุงุฑ ุงุณุชุฑุงุชูุฌูุฉุ")
        user_input = input("ุงูุชุจ 'ูุนู' ูููุชุงุจุนุฉ ุฃู ุงุถุบุท Enter ููุชุฎุทู: ")
        if user_input.lower() in ['ูุนู', 'yes', 'y']:
            example_run_backtest()
        else:
            print("   ุชู ุชุฎุทู ุงุฎุชุจุงุฑ ุงูุงุณุชุฑุงุชูุฌูุฉ.")
        
        # 6. ูุทุน ุงูุงุชุตุงู
        print("\nโถ ุงูุฎุทูุฉ 6: ูุทุน ุงูุงุชุตุงู...")
        example_disconnect()
        
        print("\n" + "โ ุงูุชูู ุงูุณููุงุฑูู ุจูุฌุงุญ!".center(60, "="))
        
    except requests.exceptions.ConnectionError:
        print("""
        โ ุฎุทุฃ ูู ุงูุงุชุตุงู!
        
        ุชุฃูุฏ ูู:
        1. ุฃู ุงูุฎุงุฏู ูุนูู ุนูู http://localhost:8000
        2. ุชุดุบูู: python main.py
        """)
    except Exception as e:
        print(f"โ ุญุฏุซ ุฎุทุฃ: {str(e)}")


# =================================================================================
#                              ููุทุฉ ุงูุฏุฎูู
# =================================================================================

if __name__ == "__main__":
    print("""
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                                  โ
    โ              ุฃูุซูุฉ ุงุณุชุฎุฏุงู ุฎุงุฏู MT5 ุงููุณูุท                        โ
    โ                                                                  โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    
    โ๏ธ ุชุฃูุฏ ูู:
    1. ุชุดุบูู ุงูุฎุงุฏู ุฃููุงู: python main.py
    2. ุชุนุฏูู ุงููุณุงุฑุงุช ูู ุฃุนูู ูุฐุง ุงูููู
    
    ุงุฎุชุฑ ุงููุซุงู ุงูุฐู ุชุฑูุฏ ุชุดุบููู:
    1. ูุญุต ุญุงูุฉ ุงูุฎุงุฏู
    2. ุงูุงุชุตุงู ุจู MT5
    3. ูุทุน ุงูุงุชุตุงู
    4. ูุนูููุงุช ุงูุญุณุงุจ
    5. ูุงุฆูุฉ ุงููุณุชุดุงุฑูู ุงูุฎุจุฑุงุก
    6. ุชุดุบูู Backtest
    7. ูุงุฆูุฉ ุงูุฑููุฒ
    8. ุณููุงุฑูู ูุงูู
    0. ุฎุฑูุฌ
    """)
    
    while True:
        choice = input("\nุงุฎุชุฑ ุฑูู ุงููุซุงู (0 ููุฎุฑูุฌ): ").strip()
        
        if choice == "0":
            print("๐ ูุน ุงูุณูุงูุฉ!")
            break
        elif choice == "1":
            example_health_check()
        elif choice == "2":
            example_connect()
        elif choice == "3":
            example_disconnect()
        elif choice == "4":
            example_account_info()
        elif choice == "5":
            example_list_experts()
        elif choice == "6":
            example_run_backtest()
        elif choice == "7":
            example_get_symbols()
        elif choice == "8":
            full_scenario()
        else:
            print("โ ุงุฎุชูุงุฑ ุบูุฑ ุตุญูุญ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.")
